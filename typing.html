<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduKids Typing Tutor — Sample (Year 1 & 2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* extra styles */
    :root{
      --navy:#07315a;
      --dark-orange:#fb852b;
      --muted-gray:#f3f4f6;
    }
    .slide-in { transform: translateX(0); transition: transform .28s ease; }
    .slide-out { transform: translateX(-110%); transition: transform .28s ease; }
    .kbd-key { min-width:36px; min-height:36px; display:inline-flex;align-items:center;justify-content:center;border-radius:6px;border:1px solid #e5e7eb;margin:2px;font-weight:700;background:white; }
    .kbd-key.home { background: #fff7ed; border-color: rgba(251,133,43,0.25); box-shadow: 0 6px 18px rgba(251,133,43,0.08); }
    .kbd-key.active { background:#ffedd5; transform: translateY(-3px); box-shadow:0 8px 24px rgba(11,49,90,0.06); }
    .char-correct { color:#166534; } /* green */
    .char-wrong { background:#fee2e2; color:#9b1c1c; }
    .chev { transition: transform .2s ease; }
    .encourage { color: var(--navy); font-weight:700; }
    .scroll-smooth { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-white text-gray-900 font-sans min-h-screen">

  <!-- HEADER -->
  <header class="bg-[color:var(--navy)] text-white fixed top-0 left-0 right-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="menuToggle" class="p-2 rounded-md bg-white/10 hover:bg-white/20 focus:ring-2 focus:ring-white">
          <!-- hamburger -->
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-[color:var(--dark-orange)] flex items-center justify-center font-bold text-white">KT</div>
          <div>
            <h1 class="text-lg font-bold">EduKids Typing Tutor</h1>
            <p class="text-xs opacity-90">Fun keyboard & mouse drills — Year 1 & 2 sample</p>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-sm px-3 py-1 rounded bg-white/10">Navy • Grey • Dark Orange</div>
      </div>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="pt-20 max-w-6xl mx-auto px-4 grid grid-cols-12 gap-6">
    <!-- SIDEBAR (slide-in) -->
    <aside id="sidebar" class="col-span-12 md:col-span-4 lg:col-span-3 fixed md:relative left-0 top-20 bottom-0 z-50 bg-gray-50 border-r p-4 overflow-auto slide-out w-[86vw] md:w-auto">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-[color:var(--navy)]">Lessons (Year 1 & 2)</h2>
        <button id="closeSidebar" class="md:hidden text-gray-600">Close</button>
      </div>

      <div id="sidebarContent" class="space-y-4">
        <!-- Class selector & nested terms will be built by JS -->
      </div>
    </aside>

    <!-- MAIN -->
    <main class="col-span-12 md:col-span-8 lg:col-span-9">
      <div id="pageContent" class="bg-white rounded-2xl shadow p-6 min-h-[60vh]">
        <!-- top controls: class select / practice type -->
        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div class="md:col-span-1">
            <label class="block text-sm text-gray-600 mb-1">Class</label>
            <select id="classSelect" class="w-full p-3 rounded border focus:ring-2 focus:ring-[color:var(--dark-orange)]">
              <option value="">Select Year</option>
            </select>
          </div>
          <div class="md:col-span-1">
            <label class="block text-sm text-gray-600 mb-1">Practice Type</label>
            <select id="practiceSelect" class="w-full p-3 rounded border focus:ring-2 focus:ring-[color:var(--dark-orange)]" disabled>
              <option value="">Choose practice</option>
              <option value="keyboard">Keyboard Drill</option>
              <option value="mouse">Mouse Practice</option>
            </select>
          </div>
          <div class="md:col-span-1">
            <label class="block text-sm text-gray-600 mb-1">Topic</label>
            <select id="topicSelect" class="w-full p-3 rounded border focus:ring-2 focus:ring-[color:var(--dark-orange)]" disabled>
              <option value="">Pick a topic</option>
            </select>
          </div>
        </div>

        <div class="mb-4">
          <button id="beginBtn" class="w-full hidden bg-[color:var(--dark-orange)] hover:bg-orange-500 text-white font-semibold py-3 rounded-lg shadow">Click here to begin training</button>
        </div>

        <!-- tutor area -->
        <section id="tutorArea" class="hidden">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
              <h2 id="topicTitle" class="text-2xl font-bold text-[color:var(--navy)]">Topic Title</h2>
              <p id="topicInfo" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-center">
                <div class="text-xs text-gray-500">Accuracy</div>
                <div id="acc" class="text-xl font-bold">0%</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-gray-500">WPM</div>
                <div id="wpm" class="text-xl font-bold">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-gray-500">Errors</div>
                <div id="errors" class="text-xl font-bold">0</div>
              </div>
              <div class="text-center">
                <div class="text-xs text-gray-500">Timer</div>
                <div id="timer" class="text-xl font-bold">—</div>
              </div>
            </div>
          </div>

          <div class="mt-4 bg-gray-100 rounded p-4 min-h-[140px]">
            <div id="instructionBox" class="text-sm text-[color:var(--navy)] font-medium mb-3"></div>
            <div id="sampleBox" class="text-2xl font-mono leading-relaxed break-words select-none"></div>
          </div>

          <textarea id="inputBox" class="mt-4 w-full p-3 rounded border border-gray-300 text-lg focus:ring-2 focus:ring-[color:var(--dark-orange)]" rows="4" placeholder="Start typing here..." disabled></textarea>

          <div class="mt-4 flex gap-2 items-center">
            <button id="prevBtn" class="px-4 py-2 bg-white border rounded hover:bg-gray-50" disabled>◀ Previous</button>
            <button id="nextBtn" class="px-4 py-2 bg-white border rounded hover:bg-gray-50 ml-auto" disabled>Next ▶</button>
            <button id="restartBtn" class="px-4 py-2 bg-white border rounded hover:bg-gray-50">Restart</button>
          </div>

          <!-- virtual keyboard (for keyboard drills) -->
          <div id="keyboardWrap" class="mt-6 bg-white border rounded p-4 hidden">
            <div class="text-sm text-gray-600 mb-2">On-screen Keyboard (home-row highlighted)</div>
            <div id="virtualKeyboard" class="flex flex-wrap"></div>
          </div>

          <div id="encourage" class="mt-4 text-sm"></div>
        </section>

      </div>
    </main>
  </div>

  <!-- Embedded small CLASSES (Year 1 & 2) -->
  <script>
  const CLASSES = {
    "classes": [
      {
        "id": "year1",
        "name": "Year 1",
        "terms": [
          {
            "number": 1,
            "title": "Term 1",
            "categories": [
              {
                "id": "keyboard",
                "name": "Keyboard",
                "topics": [
                  {
                    "title": "Home Row Keys",
                    "instruction": "Place your fingers on A S D F J K L ; and press each key when prompted.",
                    "samples": ["A", "S", "D", "F", "J", "K", "L", ";"]
                  },
                  {
                    "title": "Two Letter Words",
                    "instruction": "Type simple two-letter words using home-row letters.",
                    "samples": ["AS", "AD", "FA", "JK", "KL"]
                  },
                  {
                    "title": "Three Letter Words",
                    "instruction": "Type these three-letter words slowly and correctly.",
                    "samples": ["CAT", "DOG", "SUN", "HAT", "FUN"]
                  }
                ]
              },
              {
                "id": "mouse",
                "name": "Mouse",
                "topics": [
                  {
                    "title": "Mouse Clicks",
                    "instruction": "Practice left click, right click, and double-click on targets.",
                    "samples": ["Left Click", "Right Click", "Double Click"]
                  },
                  {
                    "title": "Drag and Drop",
                    "instruction": "Drag small shapes to their matching outlines.",
                    "samples": ["Drag Circle", "Drag Square", "Drop Triangle"]
                  }
                ]
              }
            ]
          },
          {
            "number": 2,
            "title": "Term 2",
            "categories": [
              {
                "id": "keyboard",
                "name": "Keyboard",
                "topics": [
                  {
                    "title": "Simple Words",
                    "instruction": "Type these simple 3–4 letter words clearly.",
                    "samples": ["BIRD", "FISH", "TREE", "STAR", "BALL"]
                  },
                  {
                    "title": "Common Sentences",
                    "instruction": "Type each sentence exactly as shown, including spaces.",
                    "samples": ["I am happy", "You are good", "We like to play", "It is sunny", "I can run"]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "id": "year2",
        "name": "Year 2",
        "terms": [
          {
            "number": 1,
            "title": "Term 1",
            "categories": [
              {
                "id": "keyboard",
                "name": "Keyboard",
                "topics": [
                  {
                    "title": "Home Row Drill",
                    "instruction": "Repeat the home row letters, build speed and accuracy.",
                    "samples": ["A", "S", "D", "F", "J", "K", "L", ";"]
                  },
                  {
                    "title": "Two & Three Letter Words",
                    "instruction": "Type mixed 2–3 letter words using the home row.",
                    "samples": ["AND", "SAD", "FUN", "JAM", "LAD"]
                  },
                  {
                    "title": "Five Short Words",
                    "instruction": "Type these five short words clearly.",
                    "samples": ["MAP", "PEN", "CUP", "RAT", "BAG"]
                  }
                ]
              },
              {
                "id": "mouse",
                "name": "Mouse",
                "topics": [
                  {
                    "title": "Precision Clicks",
                    "instruction": "Click accurately on small targets, practice double-click speed.",
                    "samples": ["Left Click", "Double Click", "Right Click"]
                  }
                ]
              }
            ]
          },
          {
            "number": 2,
            "title": "Term 2",
            "categories": [
              {
                "id": "keyboard",
                "name": "Keyboard",
                "topics": [
                  {
                    "title": "Typing Short Sentences",
                    "instruction": "Type short sentences, paying attention to capitalization and spacing.",
                    "samples": ["I like cake", "You are nice", "We play together", "She can sing", "He has a ball"]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  };
  </script>

  <!-- App JS -->
  <script>
  (function(){
    // Helpers
    const $ = (s, el = document) => el.querySelector(s);
    const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));

    // DOM refs
    const sidebar = $('#sidebar');
    const sidebarContent = $('#sidebarContent');
    const menuToggle = $('#menuToggle');
    const closeSidebar = $('#closeSidebar');
    const classSelect = $('#classSelect');
    const practiceSelect = $('#practiceSelect');
    const topicSelect = $('#topicSelect');
    const beginBtn = $('#beginBtn');
    const tutorArea = $('#tutorArea');
    const topicTitle = $('#topicTitle');
    const topicInfo = $('#topicInfo');
    const instructionBox = $('#instructionBox');
    const sampleBox = $('#sampleBox');
    const inputBox = $('#inputBox');
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');
    const restartBtn = $('#restartBtn');
    const keyboardWrap = $('#keyboardWrap');
    const virtualKeyboard = $('#virtualKeyboard');
    const acc = $('#acc');
    const wpm = $('#wpm');
    const errors = $('#errors');
    const timerEl = $('#timer');
    const encourage = $('#encourage');

    // initial UI state
    let sidebarOpen = false;
    function setSidebar(open){
      sidebarOpen = open;
      if(open){
        sidebar.classList.remove('slide-out'); sidebar.classList.add('slide-in');
      } else {
        sidebar.classList.remove('slide-in'); sidebar.classList.add('slide-out');
      }
    }
    setSidebar(false);

    menuToggle.addEventListener('click', ()=> setSidebar(!sidebarOpen));
    closeSidebar.addEventListener('click', ()=> setSidebar(false));

    // Build class select from CLASSES
    const classes = CLASSES.classes || [];
    classes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.name;
      classSelect.appendChild(opt);
    });

    // Sidebar nested listing (Year -> Term -> Category -> Topic)
    function buildSidebarContent(){
      sidebarContent.innerHTML = '';
      classes.forEach(c => {
        const yr = document.createElement('div');
        yr.className = 'mb-4';
        const head = document.createElement('button');
        head.className = 'w-full flex items-center justify-between px-2 py-2 rounded hover:bg-[color:var(--muted-gray)]';
        head.innerHTML = `<span class="font-semibold">${c.name}</span><svg class="w-4 h-4 chev" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        yr.appendChild(head);

        const yrBody = document.createElement('div'); yrBody.className = 'pl-3 mt-2 hidden';
        c.terms.forEach(t => {
          const tHead = document.createElement('button');
          tHead.className = 'w-full text-left px-2 py-1 rounded hover:bg-[color:var(--muted-gray)] text-sm text-blue-700';
          tHead.innerHTML = `<span class="font-medium">${t.title}</span><svg class="w-3 h-3 chev inline-block ml-2" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          yrBody.appendChild(tHead);

          const tBody = document.createElement('div'); tBody.className = 'pl-3 mt-1 hidden';
          t.categories.forEach(cat => {
            const cHead = document.createElement('button');
            cHead.className = 'w-full text-left px-2 py-1 rounded hover:bg-[color:var(--muted-gray)] text-sm text-purple-600';
            cHead.textContent = cat.name;
            tBody.appendChild(cHead);

            const catBody = document.createElement('div'); catBody.className = 'pl-3 mt-1 hidden';
            const ul = document.createElement('ul'); ul.className = 'space-y-1';
            cat.topics.forEach((topic, idx) => {
              const li = document.createElement('li');
              const a = document.createElement('button');
              a.className = 'w-full text-left px-2 py-1 rounded hover:bg-white text-sm';
              a.textContent = topic.title;
              a.addEventListener('click', () => {
                // choose class and topic in selects for quick start
                classSelect.value = c.id;
                onClassChange();
                practiceSelect.value = cat.id;
                onPracticeChange();
                // find index in topicSelect matching topic title
                for (let i=0;i<topicSelect.options.length;i++){
                  if (topicSelect.options[i].dataset.title === topic.title) {
                    topicSelect.selectedIndex = i; break;
                  }
                }
                // show begin button
                beginBtn.classList.remove('hidden');
                setSidebar(false);
                encourage.textContent = '';
              });
              li.appendChild(a); ul.appendChild(li);
            });
            catBody.appendChild(ul);
            tBody.appendChild(catBody);

            cHead.addEventListener('click', ()=> {
              const open = catBody.classList.contains('hidden');
              // collapse siblings
              tBody.querySelectorAll(':scope > div').forEach(d=> d.classList.add('hidden'));
              if (open) catBody.classList.remove('hidden');
            });
          });

          tHead.addEventListener('click', ()=> {
            const open = tBody.classList.contains('hidden');
            // collapse siblings
            yrBody.querySelectorAll(':scope > div').forEach(d=> d.classList.add('hidden'));
            if (open) tBody.classList.remove('hidden');
          });
        });

        head.addEventListener('click', ()=> {
          const open = yrBody.classList.contains('hidden');
          // collapse other years
          sidebarContent.querySelectorAll(':scope > div > div.pl-3').forEach(d => d.classList.add('hidden'));
          if (open) yrBody.classList.remove('hidden');
        });

        yr.appendChild(yrBody);
        sidebarContent.appendChild(yr);
      });
    }
    buildSidebarContent();

    // When class changes, populate practice type & topicSelect
    function onClassChange(){
      const cId = classSelect.value;
      practiceSelect.disabled = !cId;
      topicSelect.innerHTML = '<option value="">Pick a topic</option>';
      topicSelect.disabled = true;
      beginBtn.classList.add('hidden');
      tutorArea.classList.add('hidden');
      keyboardWrap.classList.add('hidden');
      encourage.textContent = '';
      if (!cId) return;
      // gather practice options available for that class (keyboard / mouse)
      const cls = classes.find(x=>x.id===cId);
      const types = new Set();
      (cls.terms||[]).forEach(t=> (t.categories||[]).forEach(cat=> types.add(cat.id)));
      // enable practiceSelect options accordingly
      $$('option', practiceSelect).forEach(opt => {
        if (!opt.value) return;
        opt.disabled = !types.has(opt.value);
        opt.hidden = !types.has(opt.value);
      });
    }
    classSelect.addEventListener('change', onClassChange);

    // When practice type changes, fill topicSelect with topics for that class & type
    function onPracticeChange(){
      const cId = classSelect.value;
      const type = practiceSelect.value;
      topicSelect.innerHTML = '<option value="">Pick a topic</option>';
      topicSelect.disabled = true;
      beginBtn.classList.add('hidden');
      tutorArea.classList.add('hidden');
      keyboardWrap.classList.add('hidden');
      encourage.textContent = '';
      if (!cId || !type) return;
      const cls = classes.find(x=>x.id===cId);
      const topicsFlat = [];
      (cls.terms||[]).forEach(t=>{
        (t.categories||[]).forEach(cat=>{
          if (cat.id === type) {
            (cat.topics||[]).forEach((topic, idx)=>{
              const opt = document.createElement('option');
              opt.value = JSON.stringify({term: t.number, cat: cat.id, idx: idx});
              opt.textContent = `${t.title} • ${cat.name} • ${topic.title}`;
              opt.dataset.title = topic.title;
              topicSelect.appendChild(opt);
            });
          }
        });
      });
      topicSelect.disabled = false;
      beginBtn.classList.remove('hidden');
    }
    practiceSelect.addEventListener('change', onPracticeChange);

    // Topic selection shows begin button (already shown by onPracticeChange)
    topicSelect.addEventListener('change', ()=>{
      beginBtn.classList.toggle('hidden', !topicSelect.value);
      tutorArea.classList.add('hidden');
      keyboardWrap.classList.add('hidden');
      encourage.textContent = '';
    });

    // Flattened navigation list for next/prev
    function gatherTopicsForSelection(cId, type){
      const list = [];
      const cls = classes.find(x=>x.id===cId);
      if (!cls) return list;
      cls.terms.forEach(t=>{
        t.categories.forEach(cat=>{
          if (cat.id === type) {
            cat.topics.forEach((topic, idx)=>{
              list.push({term: t.number, catId: cat.id, idx, topic});
            });
          }
        });
      });
      return list;
    }

    // Virtual keyboard layout and build
    const KB_LAYOUT = [
      ['`','1','2','3','4','5','6','7','8','9','0','-','=','Back'],
      ['Tab','q','w','e','r','t','y','u','i','o','p','[',']','\\'],
      ['Caps','a','s','d','f','g','h','j','k','l',';','\'','Enter'],
      ['Shift','z','x','c','v','b','n','m',',','.','/','Shift']
    ];
    function buildVirtualKeyboard(){
      virtualKeyboard.innerHTML = '';
      KB_LAYOUT.forEach(row=>{
        const rowDiv = document.createElement('div');
        rowDiv.className = 'mb-2';
        row.forEach(k=>{
          const key = document.createElement('div');
          key.className = 'kbd-key';
          key.dataset.key = (k.length === 1)? k.toLowerCase() : k.toLowerCase();
          key.textContent = k;
          // home-row highlight
          if (['a','s','d','f','j','k','l',';'].includes((k+'').toLowerCase())) key.classList.add('home');
          rowDiv.appendChild(key);
        });
        virtualKeyboard.appendChild(rowDiv);
      });
    }
    buildVirtualKeyboard();

    // Helper: parse selected topic to get object
    function getSelectedTopicObject(){
      const cId = classSelect.value;
      const sel = topicSelect.value;
      if (!cId || !sel) return null;
      const parsed = JSON.parse(sel); // {term, cat, idx}
      const cls = classes.find(x=>x.id===cId);
      const term = cls.terms.find(t=>t.number === parsed.term);
      const cat = term.categories.find(cc=>cc.id === parsed.cat);
      const topic = cat.topics[parsed.idx];
      return { cls, term, cat, topic, idx: parsed.idx };
    }

    // Practice state
    let currentSamples = []; // array of strings
    let curIndex = 0; // which sample in currentSamples
    let correctChars = 0;
    let typedChars = 0;
    let startTime = null;
    let timed = false; let timerID = null; let timerEnd = null; let timerSeconds = 0;
    let topicsList = []; // used for next/prev navigation within class+type

    // Helpers: detect timed minutes in topic
    function detectTimedMinutes(topic){
      const text = (topic.title || '') + ' ' + (topic.instruction || '');
      const m = text.match(/(\d{1,2})\s*(min|minute|minutes|min\))/i);
      if (m) return parseInt(m[1],10);
      if (/timed/i.test(text) && /5/.test(text)) return 5; // fallback
      return 0;
    }

    function resetStats(){
      correctChars = 0; typedChars = 0; startTime = null;
      acc.textContent = '0%'; wpm.textContent = '0'; errors.textContent = '0';
      timerEl.textContent = '—';
      encourage.textContent = '';
      if (timerID) { clearInterval(timerID); timerID = null; }
    }

    // Render a sample string into sampleBox with span per char
    function renderCurrentSample(){
      const s = currentSamples[curIndex] || '';
      sampleBox.innerHTML = '';
      for (let i=0;i<s.length;i++){
        const sp = document.createElement('span');
        sp.textContent = s[i];
        sp.dataset.pos = i;
        sp.className = '';
        sampleBox.appendChild(sp);
      }
      // scroll into view
      sampleBox.scrollIntoView({behavior:'smooth', block:'nearest'});
      inputBox.value = '';
      inputBox.disabled = false;
      inputBox.focus();
      updateProgressUI();
    }

    function updateProgressUI(){
      prevBtn.disabled = curIndex <= 0;
      nextBtn.disabled = curIndex >= currentSamples.length - 1;
    }

    function startTimer(seconds){
      if (timerID) clearInterval(timerID);
      timerSeconds = seconds;
      timerEnd = Date.now() + seconds*1000;
      timerEl.textContent = formatTime(seconds);
      timerID = setInterval(()=>{
        const left = Math.max(0, Math.round((timerEnd - Date.now())/1000));
        timerEl.textContent = formatTime(left);
        if (left <= 0) {
          clearInterval(timerID);
          inputBox.disabled = true;
          encourage.textContent = '⏰ Time up — well done!';
          // Optionally mark topic done
        }
      }, 300);
    }
    function formatTime(s){ return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

    function computeStats(){
      const accPct = typedChars ? Math.round((correctChars/typedChars)*100) : 0;
      acc.textContent = accPct + '%';
      const elapsedMinutes = startTime ? ((Date.now() - startTime)/1000/60) : 0;
      const words = Math.max(0, Math.round((correctChars/5)));
      const curWpm = elapsedMinutes > 0 ? Math.round(words / elapsedMinutes) : 0;
      wpm.textContent = curWpm;
      errors.textContent = Math.max(0, typedChars - correctChars);
    }

    // Visual key press
    function keyVisual(k){
      const key = virtualKeyboard.querySelector(`.kbd-key[data-key="${(k+'').toLowerCase()}"]`);
      if (key) {
        key.classList.add('active');
        setTimeout(()=> key.classList.remove('active'), 160);
      }
    }

    // Compare char: letters case-insensitive, else exact
    function charMatch(a,b){
      if (!a && !b) return true;
      if (!a || !b) return false;
      if (/[a-zA-Z]/.test(a) && /[a-zA-Z]/.test(b)) return a.toLowerCase() === b.toLowerCase();
      return a === b;
    }

    // Input handler
    inputBox.addEventListener('input', (e)=>{
      if (!startTime) {
        startTime = Date.now();
        if (timed && timerSeconds>0 && !timerID) startTimer(timerSeconds);
      }
      const val = inputBox.value;
      typedChars = (currentSamples.slice(0,curIndex).join('').length) + val.length;
      // update spans
      const spans = sampleBox.querySelectorAll('span');
      let correctThis = 0;
      for (let i=0;i<spans.length;i++){
        const expected = spans[i].textContent;
        const got = val[i] || '';
        if (got === '') { spans[i].classList.remove('char-correct','char-wrong'); }
        else if (charMatch(got, expected)) { spans[i].classList.add('char-correct'); spans[i].classList.remove('char-wrong'); correctThis++; }
        else { spans[i].classList.add('char-wrong'); spans[i].classList.remove('char-correct'); }
      }
      // Recompute totals: treat completed earlier samples as fully correct (if user moved on)
      let completedCorrect = 0;
      for (let s=0;s<curIndex;s++) completedCorrect += currentSamples[s].length;
      correctChars = completedCorrect + correctThis;
      computeStats();
      // visual keyboard
      if (val.length) keyVisual(val[val.length-1]);

      // if fully matched current sample, auto-complete to next after short delay
      const curText = currentSamples[curIndex] || '';
      let allMatch = true;
      for (let i=0;i<curText.length;i++){
        if (!charMatch(val[i]||'', curText[i])) { allMatch = false; break; }
      }
      if (val.length >= curText.length && allMatch) {
        // mark finished
        setTimeout(()=> {
          // mark all spans correct
          sampleBox.querySelectorAll('span').forEach(sp=> { sp.classList.remove('char-wrong'); sp.classList.add('char-correct'); });
          // advance
          if (curIndex < currentSamples.length - 1) {
            curIndex++;
            renderCurrentSample();
            encourage.textContent = randomEncouragement(true);
          } else {
            // last item done
            inputBox.disabled = true;
            encourage.textContent = '🎉 Topic complete — great work!';
          }
        }, 180);
      }
    });

    // keyboard physical highlight
    document.addEventListener('keydown', (e)=> {
      keyVisual(e.key);
    });

    // Begin training click
    beginBtn.addEventListener('click', ()=> {
      const selObj = getSelectedTopicObject();
      if (!selObj) return alert('Please select a topic');
      const topic = selObj.topic;
      // prepare samples
      currentSamples = (topic.samples || []).slice();
      // Build progressive difficulty: if samples are single letters/words, automatically add a few combined strings to increase difficulty
      // e.g., combine words into short phrases for later progression (simple heuristic)
      const more = [];
      // if many short words (length <=3), create combined
      const shortWords = currentSamples.filter(s => s.length <= 3);
      if (shortWords.length >= 2) {
        more.push(shortWords.join(' '));
        more.push(shortWords.slice().reverse().join(' '));
      }
      // if topic contains sentences, keep them and optionally add concatenated sentences
      const sentences = currentSamples.filter(s => s.includes(' ') || s.includes('.') || s.includes(','));
      if (sentences.length >= 2) more.push(sentences.join(' '));
      // append progressive items
      currentSamples = currentSamples.concat(more);

      curIndex = 0;
      resetStats();
      // timed?
      const mins = detectTimedMinutes(topic);
      timed = mins > 0; if (timed) { timerSeconds = mins * 60; timerEl.textContent = formatTime(timerSeconds); } else timerEl.textContent = '—';
      // Show UI
      tutorArea.classList.remove('hidden');
      instructionBox.textContent = topic.instruction || '';
      topicTitle.textContent = topic.title;
      topicInfo.textContent = `${selObj.cls.name} • ${selObj.term.title} • ${selObj.cat.name}`;
      renderCurrentSample();
      updateProgressUI();
      // If keyboard practice, show keyboard
      if (selObj.cat.id === 'keyboard') {
        keyboardWrap.classList.remove('hidden');
      } else {
        keyboardWrap.classList.add('hidden');
      }
      beginBtn.classList.add('hidden');
      encourage.textContent = 'Go on — start typing when ready!';
      // make topicsList for navigation
      topicsList = gatherTopicsForSelection(selObj.cls.id, selObj.cat.id);
      // find current absolute index (match by title)
      // Not used heavily here, but available for next/prev across whole class type
    });

    // Prev/Next/Restart handlers
    prevBtn.addEventListener('click', ()=>{
      if (curIndex > 0) { curIndex--; renderCurrentSample(); encourage.textContent = 'Try this one again!'; }
    });
    nextBtn.addEventListener('click', ()=>{
      if (curIndex < currentSamples.length - 1) { curIndex++; renderCurrentSample(); encourage.textContent = 'Keep going — you got this!'; }
    });
    restartBtn.addEventListener('click', ()=>{
      resetStats(); curIndex = 0; renderCurrentSample(); encourage.textContent = 'Restarted — take your time.'; inputBox.focus();
      // reset timer if timed
      if (timed && timerSeconds) { if (timerID) clearInterval(timerID); timerID = null; timerEl.textContent = formatTime(timerSeconds); }
    });

    // simple encouragement phrases
    function randomEncouragement(success){
      const good = ['Nice!', 'Great job!', 'Keep it up!', 'You’re improving!', 'Awesome!'];
      const tryAgain = ['Almost!', 'Try again — you can do it!', 'Keep practicing!', 'One more time!'];
      return success ? good[Math.floor(Math.random()*good.length)] : tryAgain[Math.floor(Math.random()*tryAgain.length)];
    }

    // gather topics for navigation: within selected class & type
    function gatherTopicsForSelection(cId, type){
      const list = [];
      const cls = classes.find(x=>x.id===cId);
      if (!cls) return list;
      cls.terms.forEach(t=>{
        t.categories.forEach(cat=>{
          if (cat.id === type) {
            cat.topics.forEach((topic, idx)=>{
              list.push({term: t.number, catId: cat.id, idx, topic});
            });
          }
        });
      });
      return list;
    }

    // get selected topic object function for begin handler
    function getSelectedTopicObject(){
      const sel = topicSelect.value; if (!sel) return null;
      const parsed = JSON.parse(sel);
      const cId = classSelect.value;
      const cls = classes.find(x=>x.id===cId);
      const term = cls.terms.find(t=>t.number===parsed.term);
      const cat = term.categories.find(cc=>cc.id===parsed.cat);
      const topic = cat.topics[parsed.idx];
      return { cls, term, cat, topic, idx: parsed.idx };
    }

    // expose for debugging
    window._edu = { classes };

    // initial small nicety: populate practiceSelect disabled until class chosen
    // (we already set that up)
  })();
  </script>

</body>
</html>
