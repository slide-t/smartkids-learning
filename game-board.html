<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Typing Practice</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#F3F4F6; display:flex; flex-direction:column; align-items:center;}
  header { background:#1E3A8A; color:white; padding:1rem; width:100%; text-align:center; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:1.8rem; }
  header a { color:white; background:#2563EB; padding:0.5rem 1rem; border-radius:5px; text-decoration:none; font-weight:bold; }
  .container { max-width:700px; margin-top:20px; padding:1rem; background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.2); text-align:center;}
  .practice-area { min-height:150px; padding:1rem; border:1px solid #ccc; border-radius:5px; background:#E5E7EB; display:flex; justify-content:center; align-items:center; font-size:3rem; perspective:1000px; margin-bottom:15px;}
  .key { width:60px; height:60px; line-height:60px; margin:0.3rem; text-align:center; border:2px solid #ccc; border-radius:10px; background:#D1D5DB; transform-style:preserve-3d; transition: transform 0.4s, background 0.3s;}
  .key.correct { background:#2563EB; color:white; }
  .key.wrong { background:#EF4444; color:white; }
  .flip { transform: rotateY(90deg); }
  .virtual-keyboard { display:flex; justify-content:center; flex-wrap:wrap; gap:5px; margin-top:15px; }
  .vk-key { width:50px; height:50px; line-height:50px; text-align:center; border-radius:5px; background:#D1D5DB; user-select:none; cursor:not-allowed; opacity:0.4; }
  .vk-key.active { opacity:1; cursor:pointer; background:#F9FAFB; }
  .score { font-weight:bold; margin-top:10px; color:#1E3A8A; }
  .nav-buttons { margin-top:15px; display:flex; justify-content:space-between; }
  .nav-buttons button { padding:0.5rem 1rem; border:none; border-radius:5px; background:#2563EB; color:white; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<header>
  <h1>Smart Kids Typing Practice</h1>
  <a href="classes.html">Home</a>
</header>

<div class="container">
  <div class="practice-area" id="practiceArea"></div>
  <div class="score" id="scoreDisplay">Score: 0</div>
  <div class="virtual-keyboard" id="virtualKeyboard"></div>
  <div class="nav-buttons">
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
  </div>
</div>

<script>
const practiceArea = document.getElementById('practiceArea');
const scoreDisplay = document.getElementById('scoreDisplay');
const virtualKeyboard = document.getElementById('virtualKeyboard');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let score = 0;
let currentIndex = 0;
let currentLetterIndex = 0;
let currentSequence = [];
let activeKeys = [];

const params = new URLSearchParams(window.location.search);
const classId = params.get('classId');
const termNumber = parseInt(params.get('term'));
const catId = params.get('catId');
let topicIndex = parseInt(params.get('topic'));

let classesData = [];

function highlightVK(keyChar,type='reset'){
  const vkKeys = document.querySelectorAll('.vk-key');
  vkKeys.forEach(vk=>{ vk.classList.remove('vk-active','correct','wrong'); vk.style.backgroundColor='#D1D5DB'; });
  const vk = Array.from(vkKeys).find(k=>k.textContent===keyChar);
  if(vk){
    vk.classList.add('vk-active');
    if(type==='correct') vk.style.backgroundColor='#2563EB';
    if(type==='wrong') vk.style.backgroundColor='#EF4444';
  }
}

function showCurrentLetter(){
  if(currentIndex>=currentSequence.length){
    practiceArea.innerHTML='<p>Well done! You finished this topic.</p>';
    highlightVK('');
    return;
  }
  practiceArea.innerHTML='';
  const keyDiv = document.createElement('div');
  keyDiv.classList.add('key');
  keyDiv.textContent = currentSequence[currentIndex][currentLetterIndex] || currentSequence[currentIndex];
  practiceArea.appendChild(keyDiv);
  highlightVK(keyDiv.textContent,'reset');
}

function handleInput(input){
  if(currentIndex>=currentSequence.length) return;
  if(!activeKeys.includes(input.toUpperCase())) return;

  const currentWord = currentSequence[currentIndex];
  const expectedLetter = currentWord[currentLetterIndex];
  const keyDiv = document.querySelector('.key');
  if(input.toUpperCase()===expectedLetter.toUpperCase()){
    keyDiv.classList.add('correct');
    highlightVK(expectedLetter,'correct');
    score++;
    currentLetterIndex++;
    if(currentLetterIndex>=currentWord.length){
      currentLetterIndex=0;
      currentIndex++;
      setTimeout(()=>{ keyDiv.classList.add('flip'); showCurrentLetter(); },400);
    } else {
      setTimeout(()=>{ keyDiv.classList.add('flip'); showCurrentLetter(); },400);
    }
  } else {
    keyDiv.classList.add('wrong');
    highlightVK(expectedLetter,'wrong');
    setTimeout(()=>{ keyDiv.classList.add('flip'); showCurrentLetter(); },400);
  }
  scoreDisplay.textContent=`Score: ${score}`;
}

// Capture keyboard
document.addEventListener('keydown', e=>{
  handleInput(e.key);
});

function buildVirtualKeyboard(){
  virtualKeyboard.innerHTML='';
  const allKeys = "QWERTYUIOPASDFGHJKLZXCVBNM;".split('');
  allKeys.forEach(k=>{
    const vk = document.createElement('div');
    vk.classList.add('vk-key');
    vk.textContent = k;
    if(activeKeys.includes(k)) vk.classList.add('active');
    vk.addEventListener('click',()=>handleInput(k));
    virtualKeyboard.appendChild(vk);
  });
}

function loadTopic(){
  const cls = classesData.find(c=>c.id===classId);
  if(!cls){ practiceArea.innerHTML='<p style="color:red;">Class not found</p>'; return; }
  const term = cls.terms.find(t=>t.number===termNumber);
  if(!term){ practiceArea.innerHTML='<p style="color:red;">Term not found</p>'; return; }
  const category = term.categories.find(c=>c.id===catId);
  if(!category){ practiceArea.innerHTML='<p style="color:red;">Category not found</p>'; return; }
  const topic = category.topics[topicIndex];
  if(!topic){ practiceArea.innerHTML='<p style="color:red;">Topic not found</p>'; return; }

  currentSequence = topic.sequence; // Use JSON-defined sequence
  activeKeys = [...new Set(currentSequence.join('').toUpperCase().split(''))];

  buildVirtualKeyboard();
  currentIndex=0;
  currentLetterIndex=0;
  score=0;
  scoreDisplay.textContent=`Score: ${score}`;
  showCurrentLetter();
}

// Navigation
prevBtn.addEventListener('click', ()=>{
  if(topicIndex>0){ topicIndex--; loadTopic(); }
});
nextBtn.addEventListener('click', ()=>{
  const cls = classesData.find(c=>c.id===classId);
  const term = cls.terms.find(t=>t.number===termNumber);
  const category = term.categories.find(c=>c.id===catId);
  if(topicIndex<category.topics.length-1){ topicIndex++; loadTopic(); }
});

// Load JSON
fetch('data/classes.json')
  .then(res=>res.json())
  .then(data=>{
    classesData = Array.isArray(data)? data : data.classes;
    loadTopic();
  })
  .catch(err=>{
    practiceArea.innerHTML = `<p style="color:red;">Failed to load classes.json</p>`;
    console.error(err);
  });
</script>

</body>
</html>
