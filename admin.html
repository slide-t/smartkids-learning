<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartKids Learning- Admin Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- DataTables CSS + JS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Navbar -->
  <nav class="bg-blue-700 text-white p-4 shadow-md flex justify-between items-center">
    <div class="text-2xl font-bold">SmartKids  Learning</div>
    <ul class="flex space-x-6">
      <li><a href="#" class="hover:underline">Home</a></li>
      <li><a href="#" class="hover:underline">Records</a></li>
      <li><a href="#" class="hover:underline">Export</a></li>
    </ul>
  </nav>

  <!-- Dashboard Container -->
  <main class="p-6">
    <h2 class="text-xl font-bold mb-4">📊 Student Records</h2>

    <!-- Filter Dropdown -->
    <div class="mb-4 flex items-center gap-4">
      <label for="schoolFilter" class="font-semibold">Filter by School:</label>
      <select id="schoolFilter" class="border border-gray-300 rounded p-2">
        <option value="">All Schools</option>
        <!-- Options populated dynamically -->
      </select>
    </div>

    <!-- DataTable -->
    <div class="bg-white p-4 rounded-lg shadow-lg">
      <table id="studentsTable" class="display nowrap w-full text-sm text-left text-gray-700">
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Class</th>
            <th>Subject</th>
            <th>Session</th>
            <th>Term</th>
            <th>School</th>
            <th>State</th>
            <th>Country</th>
            <th>Registered At</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data loads dynamically -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- Script to Fetch & Display -->
  <script>
    let studentTable;

    async function fetchStudents() {
      try {
        const res = await fetch("http://localhost:3000/api/students"); // 🔹 adjust for server
        const data = await res.json();

        // Destroy old DataTable if exists
        if ($.fn.DataTable.isDataTable('#studentsTable')) {
          $('#studentsTable').DataTable().clear().destroy();
        }

        // Initialize DataTable
        studentTable = $('#studentsTable').DataTable({
          data: data,
          columns: [
            { data: 'fullName' },
            { data: 'class' },
            { data: 'subject' },
            { data: 'session' },
            { data: 'term' },
            { data: 'schoolName' },
            { data: 'state' },
            { data: 'country' },
            { data: 'registeredAt' }
          ],
          dom: 'Bfrtip',
          buttons: [
            { extend: 'excelHtml5', title: 'EduKids_Student_Records' },
            { extend: 'pdfHtml5', title: 'EduKids_Student_Records' },
            { extend: 'print', title: 'EduKids Student Records' }
          ],
          responsive: true,
          pageLength: 10
        });

        // Populate school dropdown
        populateSchoolFilter(data);
      } catch (err) {
        console.error("❌ Error fetching students:", err);
      }
    }

    function populateSchoolFilter(data) {
      const uniqueSchools = [...new Set(data.map(item => item.schoolName))];
      const schoolFilter = document.getElementById("schoolFilter");

      // Clear old options
      schoolFilter.innerHTML = '<option value="">All Schools</option>';

      uniqueSchools.forEach(school => {
        const opt = document.createElement("option");
        opt.value = school;
        opt.textContent = school;
        schoolFilter.appendChild(opt);
      });
    }

    // School filter event
    document.getElementById("schoolFilter").addEventListener("change", function () {
      const selected = this.value;
      if (studentTable) {
        studentTable.column(5).search(selected).draw(); // 🔹 Column index 5 = School
      }
    });

    // Auto refresh every 15s
    setInterval(fetchStudents, 15000);
    fetchStudents();
  </script>
</body>
</html>
